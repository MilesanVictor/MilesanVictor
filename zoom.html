<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSeadragon Zoom</title>
    <script src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
    <style>
        #toolbarDiv {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: black;
            padding: 16px;
            box-sizing: border-box;
            z-index: 10001;
            transition: opacity 0.5s ease-in-out;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            color: #000000;
            overflow: hidden;
        }

        #openseadragon-viewer{
            width: 100%;
            height: 100%;
            color: #000000;
        }

        /* --- NEW --- Style for the close button */
        #close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            color: #000;
            background-color: #fff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            text-align: center;
            line-height: 35px;
            cursor: pointer;
            border: none;
            z-index: 10002; /* Higher than toolbar to ensure it's on top */
        }
        #close-btn:hover {
            background-color: #ccc;
        }
    </style>
</head>
<body>
    <!-- This is your existing toolbar -->
    <div id= "toolbarDiv" class= "toolbar"></div>

    <!-- --- NEW --- The close button -->
    <div id="close-btn">X</div>

    <div id="openseadragon-viewer"></div>

    <script>
        // --- NEW --- Get the DZI path from the URL that opened this page
        const urlParams = new URLSearchParams(window.location.search);
        const dziPath = urlParams.get('dzi');

        var viewer;

        // --- NEW --- Only initialize if a DZI path was actually provided
        if (dziPath) {
            viewer = OpenSeadragon({
                id: "openseadragon-viewer",
                prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
                // --- MODIFIED --- Use the dynamic path from the URL
                tileSources: dziPath,
                position: "static",
                animationTime: 0.5,
                constrainDuringPan: true,
                maxZoomPixelRatio: 2,
                minZoomImageRatio: 0.5,
                visibilityRatio: 1,
                showNavigator: true,
                navigatorPosition: "ABSOLUTE",
                navigatorTop:      "40px",
                navigatorLeft:     "4px",
                navigatorHeight:   "120px",
                navigatorWidth:    "145px",
                toolbar: "toolbarDiv",
            });
        } else {
            // Display an error if the page was opened incorrectly
            document.body.innerHTML = '<h1>Error: No DZI image path provided.</h1>';
        }


        // This is your existing toolbar hiding logic. It's unchanged.
        const toolbar = document.getElementById('toolbarDiv');
        let inactivityTimer;
        function hideToolbar() {
            toolbar.style.opacity = '0';
            if (viewer && viewer.navigator) {
               viewer.navigator.element.style.opacity = '0';
            }
        }

        function showAndResetTimer() {
            toolbar.style.opacity = '1';
            if (viewer && viewer.navigator) {
               viewer.navigator.element.style.opacity = '1';
            }
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(hideToolbar, 2000);
        }

        if (viewer) {
            viewer.element.addEventListener('mousemove', showAndResetTimer);
            viewer.addHandler('canvas-drag', showAndResetTimer);
            toolbar.addEventListener('mousemove', showAndResetTimer);
            viewer.addHandler('open', function() {
                showAndResetTimer();
                const navigatorEl = viewer.navigator.element;
                if (navigatorEl) {
                    navigatorEl.style.transition = 'opacity 0.5s ease-in-out';
                    navigatorEl.addEventListener('mousemove', showAndResetTimer);
                }
            });
        }

        // --- NEW --- Add the event listener for our close button
        document.getElementById('close-btn').addEventListener('click', function() {
            // This sends a 'close-iframe' message back to the main PlayCanvas window
            window.parent.postMessage('close-iframe', '*');
        });
    </script>
</body>
</html>
